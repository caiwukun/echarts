<!DOCTYPE html>
<!--
Licensed to the Apache Software Foundation (ASF) under one
or more contributor license agreements.  See the NOTICE file
distributed with this work for additional information
regarding copyright ownership.  The ASF licenses this file
to you under the Apache License, Version 2.0 (the
"License"); you may not use this file except in compliance
with the License.  You may obtain a copy of the License at

   http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing,
software distributed under the License is distributed on an
"AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
KIND, either express or implied.  See the License for the
specific language governing permissions and limitations
under the License.
-->


<html>
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <script src="lib/simpleRequire.js"></script>
        <script src="lib/config.js"></script>
        <script src="lib/jquery.min.js"></script>
        <script src="lib/facePrint.js"></script>
        <script src="lib/testHelper.js"></script>
        <!-- <script src="ut/lib/canteen.js"></script> -->
        <link rel="stylesheet" href="lib/reset.css" />
    </head>
    <body>
        <style>
        </style>



        <div id="main0"></div>
        <div id="main1"></div>






        <script>
        require([
            'echarts',
            // 'map/js/china',
            // './data/nutrients.json'
    ], function (echarts) {
            var option;

            option = {
                xAxis: {
                    data: ['Animals', 'Fruits', 'Cars']
                },
                yAxis: {},
                dataGroupId: '',
                // animationDurationUpdate: 1000,
                series: {
                    type: 'bar',
                    id: 'main',
                    data: [{
                        value: 5,
                        groupId: 'animals'
                    }, {
                        value: 2,
                        groupId: 'fruits'
                    }, {
                        value: 4,
                        groupId: 'cars'
                    }],
                    universalTransition: {
                        enabled: true
                    }
                }
            };

            const drilldownData = [{
                dataGroupId: 'animals',
                data: [
                    ['Cats', 4],
                    ['Dogs', 2],
                    ['Cows', 1],
                    ['Sheep', 2],
                    ['Pigs', 1]
                ]
            }, {
                dataGroupId: 'fruits',
                data: [
                    ['Apples', 4],
                    ['Oranges', 2]
                ]
            }, {
                dataGroupId: 'cars',
                data: [
                    ['Toyota', 4],
                    ['Opel', 2],
                    ['Volkswagen', 2]
                ]
            }];

            var chart = testHelper.create(echarts, 'main0', {
                title: [
                    'Drilldown of bar chart.'
                ],
                option: option
                // height: 300,
                // buttons: [{text: 'btn-txt', onclick: function () {}}],
            });

            chart.on('click', function (event) {
                if (event.data) {
                    const subData = drilldownData.find(data => {
                        return data.dataGroupId === event.data.groupId;
                    });
                    if (!subData) {
                        return;
                    }
                    chart.setOption({
                        xAxis: {
                            data: subData.data.map(item => item[0])
                        },
                        yAxis: {},
                        series: {
                            type: 'bar',
                            id: 'main',
                            // animationDurationUpdate: 1000,
                            dataGroupId: subData.dataGroupId,
                            data: subData.data.map(item => item[1]),
                            universalTransition: {
                                enabled: true
                            }
                        },
                        graphic: [{
                            type: 'text',
                            left: 50,
                            top: 20,
                            style: {
                                text: 'Back',
                                fontSize: 18
                            },
                            onclick() {
                                chart.setOption(option);
                            }
                        }]
                    });
                }
            });
        });
        </script>



        <script>
            require([
                'echarts', 'ecStat', 'ecSimpleTransform',
                'data/life-expectancy-table.json'
            ], function (echarts, ecStat, ecSimpleTransform, rawData) {

                echarts.registerTransform(ecSimpleTransform.aggregate);
                echarts.registerTransform(ecSimpleTransform.id);

                const optionCreators = {
                    'CountryAB_Year_Income_Bar'(datasetId, itemGroupId) {
                        return {
                            xAxis: {
                                type: 'category'
                            },
                            yAxis: {
                                name: 'Income'
                            },
                            series: {
                                type: 'bar',
                                id: 'main',
                                coordinateSystem: 'cartesian2d',
                                datasetId,
                                universalTransition: {
                                    enabled: true
                                },
                                encode: {
                                    x: 'Year',
                                    y: 'Income',
                                    itemName: 'Year',
                                    itemGroupId,
                                    tooltip: ['Income'],
                                }
                            }
                        };
                    },

                    'CountryAB_Year_Population_Bar'(datasetId, itemGroupId) {
                        return {
                            xAxis: {
                                type: 'category'
                            },
                            yAxis: {
                                name: 'Population'
                            },
                            series: {
                                type: 'bar',
                                id: 'main',
                                coordinateSystem: 'cartesian2d',
                                datasetId,
                                universalTransition: {
                                    enabled: true
                                },
                                encode: {
                                    x: 'Year',
                                    y: 'Population',
                                    itemName: 'Year',
                                    itemGroupId,
                                    tooltip: ['Population'],
                                }
                            }
                        };
                    },

                    'CountryAB_Income_Population_Scatter'(datasetId, itemGroupId) {
                        return {
                            xAxis: {
                                name: 'Income',
                                scale: true
                            },
                            yAxis: {
                                name: 'Population',
                                scale: true
                            },
                            series: {
                                type: 'scatter',
                                id: 'main',
                                coordinateSystem: 'cartesian2d',
                                datasetId,
                                universalTransition: {
                                    enabled: true
                                },
                                encode: {
                                    x: 'Income',
                                    y: 'Population',
                                    itemName: ['Year'],
                                    itemGroupId,
                                    tooltip: ['Income', 'Population', 'Country']
                                }
                            }
                        };
                    },


                    'CountryAB_Income_Sum_Bar'(datasetId, itemGroupId) {
                        return {
                            xAxis: {
                                name: 'Income'
                            },
                            yAxis: {
                                type: 'category'
                            },
                            series: {
                                type: 'bar',
                                id: 'main',
                                coordinateSystem: 'cartesian2d',
                                datasetId,
                                universalTransition: {
                                    enabled: true
                                },
                                encode: {
                                    x: 'Income',
                                    y: 'Country',
                                    itemName: ['Country'],
                                    itemGroupId,
                                    tooltip: ['Income']
                                }
                            }
                        };
                    }
                };

                let currentStageIdx = 0;

                const stages = [
                    {
                        option: optionCreators['CountryAB_Year_Income_Bar']('CountryABData', 'Country')
                    },
                    {
                        option: optionCreators['CountryAB_Year_Population_Bar']('CountryABData', 'Country')
                    },
                    {
                        option: optionCreators['CountryAB_Income_Population_Scatter']('CountryABData', 'Country')
                    },
                    {
                        option: optionCreators['CountryAB_Income_Sum_Bar']('CountryABSumIncome', 'Country')
                    }
                    // {
                    //     option: optionCreators['CountryAB_Year_Income_Bar']('CountryABData', 'Country')
                    // }
                ];

                const RAW_DATA_DIMENSIONS = ['Income', 'Life Expectancy', 'Population', 'Country', 'Year'];
                const ID_RAW_DATA_DIMENSIONS = ['Income', 'Life Expectancy', 'Population', 'Country', 'Year', 'Id'];
                const SUM_INCOME_DIMENSIONS = ['Income', 'Country'];
                var COUNTRY_A = 'Germany';
                var COUNTRY_B = 'France';

                const baseOption = {
                    animationDurationUpdate: 1000,
                    dataset: [{
                        id: 'RawData',
                        source: rawData
                    }, {
                        id: 'IdRawData',
                        fromDatasetId: 'RawData',
                        transform: [{
                            type: 'filter',
                            config: {
                                dimension: 'Year', gte: 1950
                            }
                        }, {
                            type: 'ecSimpleTransform:id',
                            config: {
                                dimensionIndex: ID_RAW_DATA_DIMENSIONS.indexOf('Id'),
                                dimensionName: 'Id'
                            }
                        }]
                    }, {
                        id: 'CountryABData',
                        fromDatasetId: 'IdRawData',
                        transform: {
                            type: 'filter',
                            config: {
                                or: [{
                                    dimension: 'Country', '=': COUNTRY_A
                                }, {
                                    dimension: 'Country', '=': COUNTRY_B
                                }]
                            }
                        }
                    }, {
                        id: 'CountryABSumIncome',
                        fromDatasetId: 'CountryABData',
                        transform: {
                            type: 'ecSimpleTransform:aggregate',
                            config: {
                                resultDimensions: [
                                    { from: 'Income', method: 'sum' },
                                    { from: 'Country' }
                                ],
                                groupBy: 'Country'
                            }
                        }
                    }],
                    tooltip: {},
                    series: []
                };

                function createOption() {
                    return Object.assign({}, baseOption, stages[currentStageIdx].option);
                }
                function createNextOption() {
                    currentStageIdx = (currentStageIdx + 1) % stages.length;
                    const option = createOption();
                    return option;
                }

                function createPrevOption() {
                    currentStageIdx = (currentStageIdx - 1) % stages.length;
                    const option = createOption();
                    return option;
                }

                var chart = testHelper.create(echarts, 'main1', {
                    title: [
                        'Transition with dataset transform.'
                    ],
                    option: createOption(),
                    // height: 300,
                    buttons: [{
                        text: 'prev',
                        onclick: function () {
                            chart.setOption(createPrevOption(), {
                                replaceMerge: ['xAxis', 'yAxis']
                            });
                        }
                    }, {
                        text: 'next',
                        onclick: function () {
                            chart.setOption(createNextOption(), {
                                replaceMerge: ['xAxis', 'yAxis']
                            });
                        }
                    }],
                });
            });
        </script>
    </body>
</html>

