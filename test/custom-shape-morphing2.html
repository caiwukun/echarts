<!DOCTYPE html>
<!--
Licensed to the Apache Software Foundation (ASF) under one
or more contributor license agreements.  See the NOTICE file
distributed with this work for additional information
regarding copyright ownership.  The ASF licenses this file
to you under the Apache License, Version 2.0 (the
"License"); you may not use this file except in compliance
with the License.  You may obtain a copy of the License at

   http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing,
software distributed under the License is distributed on an
"AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
KIND, either express or implied.  See the License for the
specific language governing permissions and limitations
under the License.
-->

<html>
    <head>
        <meta charset='utf-8'>
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <script src="lib/esl.js"></script>
        <script src="lib/config.js"></script>
        <script src='lib/jquery.min.js'></script>
        <script src="../dist/echarts.js"></script>
        <script src="lib/testHelper.js"></script>
        <script src="lib/myTransform/aggregate.js"></script>
        <script src="lib/transitionPlayer.js"></script>
        <link rel="stylesheet" href="lib/reset.css" />
    </head>
    <body>
        <style>
        </style>

        <div id="main0"></div>



        <script>

            function initRawData(count) {
                var M_TAG_LIST = ['MA', 'MB', 'MC', 'MD'];
                var Z_TAG_LIST = ['ZA', 'ZB', 'ZC', 'ZD', 'ZE'];
                var data = [];
                var currDate = +new Date(2015, 2, 1);
                var ONE_DAY = 3600 * 24 * 1000;
                for (var i = 0; i < count; i++, currDate += ONE_DAY) {
                    data.push([
                        currDate,
                        makeRandomValue([10, 40], 0),
                        makeRandomValue([0.01, 0.99], 2),
                        makeRandomValue([1, 10], 1),
                        // makeRandomValue([1000, 9000], 0),
                        // makeRandomValue([1000, 9000], 0),
                        // makeRandomValue([10, 90], 0),
                        M_TAG_LIST[makeRandomValue([0, M_TAG_LIST.length - 1], 0)],
                        Z_TAG_LIST[makeRandomValue([0, Z_TAG_LIST.length - 1], 0)],
                        'P' + i,
                    ]);
                }

                function makeRandomValue(range, precision) {
                    return +(
                        Math.random() * (range[1] - range[0]) + range[0]
                    ).toFixed(precision);
                }

                return data;
            }
        </script>



        <script>

            require(['echarts', 'ecStat'], function (echarts, ecStat) {

                echarts.registerTransform(window.myTransform.aggregate);
                echarts.registerTransform(ecStat.transform.clustering);


                const PIE_COLORS = [
                    '#e06343', '#37a354', '#b55dba', '#b5bd48', '#8378EA', '#96BFFF'
                ];
                const CLUSTER_COLORS = [
                    '#cc5664', '#9bd6ec', '#ea946e', '#8acaaa', '#f1ec64', '#ee8686', '#a48dc1', '#5da6bc', '#b9dcae'
                ];
                var COUNT = 50;
                var CONTENT_COLOR = '#37A2DA';

                var ANIMATION_DURATION_UPDATE = 1500;

                // var rawData = initRawData(COUNT);
                // console.log(JSON.stringify(rawData));
                var rawData = [[1425139200000,34,0.13,2,"MD","ZD","P0"],[1425225600000,28,0.71,1.5,"MB","ZD","P1"],[1425312000000,23,0.9,2.8,"MA","ZC","P2"],[1425398400000,21,0.58,6,"MB","ZC","P3"],[1425484800000,14,0.1,1.6,"MC","ZA","P4"],[1425571200000,21,0.6,7.7,"MC","ZA","P5"],[1425657600000,23,0.31,2.6,"MC","ZC","P6"],[1425744000000,34,0.74,2.4,"MD","ZE","P7"],[1425830400000,14,0.59,2.3,"MB","ZD","P8"],[1425916800000,18,0.85,5.1,"MB","ZB","P9"],[1426003200000,36,0.96,1.2,"MC","ZC","P10"],[1426089600000,18,0.28,2.5,"MA","ZC","P11"],[1426176000000,20,0.62,6,"MB","ZD","P12"],[1426262400000,32,0.79,1.7,"MB","ZA","P13"],[1426348800000,17,0.58,4.4,"MD","ZB","P14"],[1426435200000,23,0.77,3,"MB","ZA","P15"],[1426521600000,39,0.87,4.6,"MC","ZA","P16"],[1426608000000,15,0.7,6,"MB","ZC","P17"],[1426694400000,21,0.94,2.7,"MB","ZD","P18"],[1426780800000,28,0.48,4.5,"MC","ZC","P19"],[1426867200000,31,0.49,9.8,"MA","ZC","P20"],[1426953600000,27,0.87,7.7,"MB","ZB","P21"],[1427040000000,27,0.82,5.5,"MC","ZB","P22"],[1427126400000,11,0.53,2.7,"MD","ZC","P23"],[1427212800000,13,0.7,7.6,"MB","ZD","P24"],[1427299200000,39,0.99,4.8,"MB","ZD","P25"],[1427385600000,32,0.91,2.1,"MB","ZE","P26"],[1427472000000,20,0.97,5,"MB","ZA","P27"],[1427558400000,36,0.01,8.9,"MB","ZD","P28"],[1427644800000,22,0.08,9.2,"MB","ZE","P29"],[1427731200000,21,0.36,3.1,"MD","ZC","P30"],[1427817600000,11,0.15,5.8,"MD","ZB","P31"],[1427904000000,39,0.02,1.4,"MC","ZD","P32"],[1427990400000,20,0.86,8.7,"MB","ZD","P33"],[1428076800000,23,0.24,7.2,"MD","ZB","P34"],[1428163200000,12,0.06,2,"MD","ZB","P35"],[1428249600000,36,0.42,8.2,"MA","ZB","P36"],[1428336000000,17,0.48,7.5,"MB","ZC","P37"],[1428422400000,19,0.12,6.6,"MB","ZB","P38"],[1428508800000,39,0.58,3.1,"MC","ZE","P39"],[1428595200000,10,0.18,6.6,"MC","ZD","P40"],[1428681600000,22,0.28,2.1,"MB","ZE","P41"],[1428768000000,27,0.33,1.9,"MC","ZB","P42"],[1428854400000,37,0.46,9.4,"MD","ZE","P43"],[1428940800000,18,0.96,5.5,"MB","ZA","P44"],[1429027200000,11,0.61,8.2,"MD","ZC","P45"],[1429113600000,15,0.88,4.6,"MD","ZA","P46"],[1429200000000,38,0.89,7.2,"MD","ZC","P47"],[1429286400000,20,0.39,5.4,"MB","ZB","P48"],[1429372800000,30,0.71,5.5,"MA","ZA","P49"]];

                var RAW_DATA_DIMENSIONS = ['DATE', 'ATA', 'STE', 'CTZ', 'M_TAG', 'Z_TAG', 'ID'];
                var M_TAG_SUM_DIMENSIONS = ['ATA', 'STE', 'CTZ', 'M_TAG'];
                var RAW_CLUSTER_DIMENSIONS = ['DATE', 'ATA', 'STE', 'CTZ', 'M_TAG', 'Z_TAG', 'ID', 'CLUSTER_IDX', 'CLUSTER_CENTER_ATA', 'CLUSTER_CENTER_STE'];
                var RAW_CLUSTER_CENTERS_DIMENSIONS = ['COUNT', 'CLUSTER_IDX', 'CLUSTER_CENTER_ATA', 'CLUSTER_CENTER_STE'];


                var baseOption = {
                    dataset: [{
                        id: 'raw',
                        dimensions: RAW_DATA_DIMENSIONS,
                        source: rawData
                    }, {
                        id: 'mTagSum',
                        fromDatasetId: 'raw',
                        transform: {
                            type: 'myTransform:aggregate',
                            config: {
                                resultDimensions: [
                                    { from: 'ATA', method: 'sum' },
                                    { from: 'STE', method: 'sum' },
                                    { from: 'CTZ', method: 'sum' },
                                    { from: 'M_TAG' }
                                ],
                                groupBy: 'M_TAG'
                            }
                        }
                    }, {
                        id: 'rawClusters',
                        fromDatasetId: 'raw',
                        transform: {
                            type: 'ecStat:clustering',
                            print: true,
                            config: {
                                clusterCount: 4,
                                dimensions: ['ATA', 'STE'],
                                outputClusterIndexDimension: {
                                    index: RAW_CLUSTER_DIMENSIONS.indexOf('CLUSTER_IDX'),
                                    name: 'CLUSTER_IDX'
                                },
                                outputCentroidDimensions: [{
                                    index: RAW_CLUSTER_DIMENSIONS.indexOf('CLUSTER_CENTER_ATA'),
                                    name: 'CLUSTER_CENTER_ATA'
                                }, {
                                    index: RAW_CLUSTER_DIMENSIONS.indexOf('CLUSTER_CENTER_STE'),
                                    name: 'CLUSTER_CENTER_STE'
                                }]
                            }
                        }
                    }, {
                        id: 'rawClusterCenters',
                        fromDatasetId: 'rawClusters',
                        transform: {
                            type: 'myTransform:aggregate',
                            print: true,
                            config: {
                                resultDimensions: [
                                    { name: 'COUNT', from: 'ATA', method: 'count' },
                                    { from: 'CLUSTER_CENTER_ATA' },
                                    { from: 'CLUSTER_CENTER_STE' },
                                    { from: 'CLUSTER_IDX' }
                                ],
                                groupBy: 'CLUSTER_IDX'
                            }
                        }
                    }],
                    tooltip: {}
                };


                var AXIS_STYLE = {
                    splitLine: {
                        lineStyle: {
                            color: '#333'
                        }
                    },
                    axisLine: {
                        lineStyle: {
                            color: '#777'
                        }
                    },
                    axisLabel: {
                        color: '#999',
                        fontSize: 20,
                        fontFamily: 'Lato'
                    }
                };
                var BG_COLOR = '#000';

                var optionCreators = {

                    'Scatter_ATA_STE': function (datasetId) {
                        return {
                            backgroundColor: BG_COLOR,
                            grid: {
                                containLabel: true
                            },
                            xAxis: {
                                name: 'STE',
                                ...AXIS_STYLE
                            },
                            yAxis: {
                                name: 'ATA',
                                ...AXIS_STYLE
                            },
                            dataZoom: [{
                                type: 'slider',
                            }, {
                                type: 'inside'
                            }],
                            series: {
                                type: 'custom',
                                coordinateSystem: 'cartesian2d',
                                animationDurationUpdate: ANIMATION_DURATION_UPDATE,
                                datasetId: datasetId,
                                encode: {
                                    itemName: 'ID',
                                    x: 'STE',
                                    y: 'ATA',
                                    tooltip: ['STE', 'ATA']
                                },
                                renderItem: function (params, api) {
                                    var pos = api.coord([
                                        api.value('STE'),
                                        api.value('ATA')
                                    ]);
                                    // var clusterIndex = api.value('CLUSTER_IDX');
                                    return {
                                        type: 'circle',
                                        morph: true,
                                        shape: {
                                            cx: pos[0],
                                            cy: pos[1],
                                            r: 10
                                        },
                                        style: {
                                            fill: CONTENT_COLOR,
                                            // fill: PIE_COLORS[clusterIndex],
                                            stroke: '#555',
                                            // lineWidth: 1
                                            lineWidth: 0
                                        },
                                        transition: ['shape', 'style']
                                    };
                                }
                            }
                        };
                    },

                    'Bar_mSum_ATA': function (datasetId) {
                        return {
                            backgroundColor: BG_COLOR,
                            grid: {
                                containLabel: true
                            },
                            xAxis: {
                                type: 'category',
                                ...AXIS_STYLE
                            },
                            yAxis: {
                                ...AXIS_STYLE
                            },
                            dataZoom: [{
                                type: 'slider',
                            }, {
                                type: 'inside'
                            }],
                            series: {
                                type: 'custom',
                                coordinateSystem: 'cartesian2d',
                                animationDurationUpdate: ANIMATION_DURATION_UPDATE,
                                datasetId: datasetId,
                                encode: {
                                    x: 'M_TAG',
                                    y: 'ATA',
                                    tooltip: ['M_TAG', 'ATA']
                                },
                                renderItem: function (params, api) {
                                    var mTagVal = api.value('M_TAG');
                                    var ataVal = api.value('ATA');
                                    var tarPos = api.coord([mTagVal, ataVal]);
                                    var zeroPos = api.coord([mTagVal, 0]);
                                    var size = api.size([mTagVal, ataVal]);
                                    var width = size[0] * 0.4;
                                    return {
                                        type: 'rect',
                                        morph: true,
                                        shape: {
                                            x: tarPos[0] - width / 2,
                                            y: tarPos[1],
                                            height: zeroPos[1] - tarPos[1],
                                            width: width,
                                        },
                                        style: {
                                            fill: CONTENT_COLOR,
                                            stroke: '#555',
                                            lineWidth: 0
                                        },
                                        transition: ['shape', 'style']
                                    };
                                }
                            }
                        };
                    },

                    'Pie_mSum_ATA': function (datasetId) {
                        return {
                            backgroundColor: BG_COLOR,
                            series: {
                                type: 'custom',
                                coordinateSystem: 'none',
                                animationDurationUpdate: ANIMATION_DURATION_UPDATE,
                                datasetId: datasetId,
                                encode: {
                                    itemName: 'M_TAG',
                                    value: 'ATA',
                                    tooltip: 'ATA'
                                },
                                renderItem: function (params, api) {
                                    var context = params.context;
                                    if (!context.layout) {
                                        context.layout = true;
                                        var totalValue = 0;
                                        for (var i = 0; i < params.dataInsideLength; i++) {
                                            totalValue += api.value('ATA', i);
                                        }
                                        var angles = [];
                                        var colors = [];
                                        var currentAngle = -Math.PI / 2;
                                        for (var i = 0; i < params.dataInsideLength; i++) {
                                            colors.push(PIE_COLORS[i]);
                                            var angle = api.value('ATA', i) / totalValue * Math.PI * 2;
                                            angles.push([currentAngle, angle + currentAngle - 0.01]);
                                            currentAngle += angle;
                                        }
                                        context.angles = angles;
                                        context.colors = colors;
                                    }

                                    var width = chart.getWidth();
                                    var height = chart.getHeight();
                                    return {
                                        type: 'sector',
                                        morph: true,
                                        shape: {
                                            cx: width / 2,
                                            cy: height / 2,
                                            r: Math.min(width, height) / 3,
                                            r0: Math.min(width, height) / 5,
                                            startAngle: context.angles[params.dataIndex][0],
                                            endAngle: context.angles[params.dataIndex][1],
                                            clockwise: true
                                        },
                                        style: {
                                            // fill: CONTENT_COLOR,
                                            fill: context.colors[params.dataIndex],
                                            stroke: '#555',
                                            lineWidth: 0,
                                            strokeNoScale: true
                                        },
                                        transition: ['shape', 'style']
                                    };
                                }
                            }
                        };
                    },

                    'Scatter_ATA_STE_Cluster_Center': function (datasetId) {
                        return {
                            backgroundColor: BG_COLOR,
                            grid: {
                                containLabel: true
                            },
                            xAxis: {
                                name: 'STE',
                                ...AXIS_STYLE
                            },
                            yAxis: {
                                name: 'ATA',
                                ...AXIS_STYLE
                            },
                            dataZoom: [{
                                type: 'slider',
                            }, {
                                type: 'inside'
                            }],
                            series: {
                                type: 'custom',
                                coordinateSystem: 'cartesian2d',
                                animationDurationUpdate: ANIMATION_DURATION_UPDATE,
                                datasetId: datasetId,
                                encode: {
                                    x: 'CLUSTER_CENTER_STE',
                                    y: 'CLUSTER_CENTER_ATA',
                                    tooltip: ['CLUSTER_CENTER_STE', 'CLUSTER_CENTER_ATA']
                                },
                                renderItem: function (params, api) {
                                    var context = params.context;
                                    if (!context.layout) {
                                        context.layout = true;
                                        context.totalCount = 0;
                                        for (var i = 0; i < params.dataInsideLength; i++) {
                                            context.totalCount += api.value('COUNT', i);
                                        }
                                    }

                                    var pos = api.coord([
                                        api.value('CLUSTER_CENTER_STE'),
                                        api.value('CLUSTER_CENTER_ATA')
                                    ]);
                                    var count = api.value('COUNT');
                                    var radius = count / context.totalCount * 100 + 10;
                                    return {
                                        type: 'circle',
                                        morph: true,
                                        shape: {
                                            cx: pos[0],
                                            cy: pos[1],
                                            r: radius,
                                        },
                                        style: {
                                            // fill: CONTENT_COLOR,
                                            fill: CLUSTER_COLORS[params.dataIndex],
                                            stroke: '#555',
                                            lineWidth: 0
                                        },
                                        transition: ['shape', 'style']
                                    };
                                }
                            }
                        };
                    }
                };


                var player = transitionPlayer.create({
                    chart: function () {
                        return chart;
                    },
                    seriesIndex: 0,
                    replaceMerge: ['xAxis', 'yAxis'],
                    dataMeta: {
                        raw: {
                            dimensions: RAW_DATA_DIMENSIONS
                        },
                        mTagSum: {
                            dimensions: M_TAG_SUM_DIMENSIONS,
                            uniqueDimension: 'M_TAG',
                        },
                        rawClusters: {
                            dimensions: RAW_CLUSTER_DIMENSIONS
                        },
                        rawClusterCenters: {
                            dimensions: RAW_CLUSTER_CENTERS_DIMENSIONS,
                            uniqueDimension: 'CLUSTER_IDX'
                        }
                    },
                    optionList: [{
                        key: 'Scatter_ATA_STE',
                        dataMetaKey: 'rawClusters',
                        option: optionCreators['Scatter_ATA_STE']('rawClusters')
                    }, {
                        key: 'Bar_mTagSum_ATA',
                        dataMetaKey: 'mTagSum',
                        option: optionCreators['Bar_mSum_ATA']('mTagSum')
                    }, {
                        key: 'Pie_mTagSum_ATA',
                        dataMetaKey: 'mTagSum',
                        option: optionCreators['Pie_mSum_ATA']('mTagSum')
                    }, {
                        key: 'Scatter_ATA_STE_Cluster_Center',
                        dataMetaKey: 'rawClusterCenters',
                        option: optionCreators['Scatter_ATA_STE_Cluster_Center']('rawClusterCenters')
                    }]
                });


                var chart = testHelper.create(echarts, 'main0', {
                    title: [
                        'Test: buttons, should morph animation merge/split.',
                        'Test: click buttons **before animation finished**, should no blink.',
                        'Test: click buttons **twice**, should no blink.',
                        'Test: use dataZoom, update animation should exist'
                    ],
                    option: baseOption,
                    lazyUpdate: true,
                    height: 600,
                    buttons: [{
                        text: 'Bar_mTagSum_ATA',
                        onclick: function () {
                            player.go('Bar_mTagSum_ATA');
                        }
                    }, {
                        text: 'Scatter_ATA_STE',
                        onclick: function () {
                            player.go('Scatter_ATA_STE');
                        }
                    }, {
                        text: 'Pie_mTagSum_ATA',
                        onclick: function () {
                            player.go('Pie_mTagSum_ATA');
                        }
                    }, {
                        text: 'Scatter_ATA_STE_Cluster_Center',
                        onclick: function () {
                            player.go('Scatter_ATA_STE_Cluster_Center');
                        }
                    }]
                });

                player.go('Scatter_ATA_STE');

            });

        </script>



    </body>
</html>